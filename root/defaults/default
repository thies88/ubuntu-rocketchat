# This is a default site configuration.

map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
}

# Upstreams
upstream backend {
    server 127.0.0.1:3000;
}

server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;

        # You can increase the limit if your need to.
        client_max_body_size 200M;
        error_log /config/log/nginx/rocketchat.access.log;

        #ssl on;
		# Path to certificate files.
		ssl_certificate /config/keys/cert.crt;
        ssl_certificate_key /config/keys/cert.key;
        ssl_protocols TLSv1.2; # don’t use SSLv3 ref: POODLE

        # Path of the file with Diffie-Hellman parameters for EDH ciphers.
        #ssl_dhparam /etc/ssl/dhparam.pem;

        # Redirect HTTP traffic.
        # https://serverfault.com/a/664936
        error_page 497 301 =307 https://$http_host$request_uri;

		 location / {
				proxy_pass http://backend;
				proxy_http_version 1.1;
				proxy_set_header Upgrade $http_upgrade;
				proxy_set_header Connection "upgrade";
				proxy_set_header Host $http_host;

				proxy_set_header X-Real-IP $remote_addr;
				proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_set_header X-Forwarded-Proto https;
				proxy_set_header X-Nginx-Proxy true;

				proxy_redirect off;
			}

}